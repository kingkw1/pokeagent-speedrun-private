"""
Test multi-flag state system for dialogue handling

⚠️ CRITICAL: DO NOT USE memory-based dialogue detection (in_dialog flag)!
   Memory flags are UNRELIABLE in Pokemon Emerald.
   
✅ CORRECT: 
   - Tests use VLM (same as agent) to validate agent behavior
   - VLM detection with automatic OCR fallback (agent/perception.py)
   - This tests what the agent actually uses in production
   
This test verifies dialogue detection accuracy and multi-flag state.
"""
import pytest
from pokemon_env.emulator import EmeraldEmulator
from agent.perception import perception_step
from utils.vlm import VLM


@pytest.fixture(scope="module")
def vlm():
    """Initialize VLM once for all tests"""
    return VLM(backend='local', model_name='Qwen/Qwen2-VL-2B-Instruct')


def test_dialogue_multi_flag_detection(vlm):
    """
    Test that VLM correctly detects dialogue in dialog2.state.
    
    NOTE: Uses VLM (same as agent), NOT memory flags!
    Tests should use same detection method as agent for realistic validation.
    """
    
    # Initialize emulator with dialog2.state (known working state)
    env = EmeraldEmulator('Emerald-GBAdvance/rom.gba', headless=True)
    env.initialize()
    env.load_state('tests/save_states/dialog2.state')
    env.tick(60)
    
    # Get state and screenshot
    state = env.get_comprehensive_state()
    screenshot = env.get_screenshot()
    
    # Use VLM perception (same as agent uses)
    print("\n=== VLM-Based Dialogue Detection (Agent's Method) ===")
    visual_data = perception_step(state, screenshot, vlm)
    
    # Check VLM detection
    on_screen_text = visual_data.get('on_screen_text', {})
    dialogue_text = on_screen_text.get('dialogue', '')
    has_dialogue = dialogue_text and len(dialogue_text.strip()) > 3
    
    print(f"VLM detected dialogue: {has_dialogue}")
    if has_dialogue:
        print(f"Dialogue text: '{dialogue_text}'")
    
    # Get memory state for comparison (but don't trust it!)
    game = state['game']
    
    print("\n=== Memory Flags (UNRELIABLE - for reference only) ===")
    print(f"overworld_visible: {game.get('overworld_visible')}")
    print(f"in_dialog (UNRELIABLE!): {game.get('in_dialog')}")
    print(f"movement_enabled: {game.get('movement_enabled')}")
    print(f"input_blocked: {game.get('input_blocked')}")
    
    # Verify VLM detected dialogue
    assert has_dialogue, \
        "VLM should detect dialogue in dialog2.state (same as agent uses)"
    
    print("\n✓ VLM-based dialogue detection working (same as agent)")
    print("✓ Tests and agent use same detection method for consistency")
    
    env.close()


def test_state_consistency_no_override(vlm):
    """
    Test that VLM dialogue detection is consistent across multiple frames.
    
    NOTE: Uses VLM (same as agent), not memory flags!
    """
    
    env = EmeraldEmulator('Emerald-GBAdvance/rom.gba', headless=True)
    env.initialize()
    env.load_state('tests/save_states/dialog2.state')
    env.tick(60)
    
    # Read VLM detection multiple times to ensure consistency
    dialogue_detections = []
    for i in range(3):
        env.tick(10)
        state = env.get_comprehensive_state()
        screenshot = env.get_screenshot()
        visual_data = perception_step(state, screenshot, vlm)
        
        on_screen_text = visual_data.get('on_screen_text', {})
        dialogue_text = on_screen_text.get('dialogue', '')
        dialogue_detections.append(dialogue_text)
    
    print("\n=== VLM Detection Consistency Test ===")
    
    for i, dialogue in enumerate(dialogue_detections):
        has_dialogue = dialogue and len(dialogue.strip()) > 3
        print(f"Read {i+1}: dialogue detected={has_dialogue}, text='{dialogue[:50] if dialogue else None}'")
        
        # All reads should consistently show dialogue
        assert has_dialogue, \
            f"Read {i+1}: VLM should consistently detect dialogue in dialog2.state"
    
    print("\n✓ VLM detection remains consistent across multiple reads")
    print("✓ Using VLM (same as agent) for test validation")
    
    env.close()


def test_multi_flag_internal_consistency(vlm):
    """
    Test VLM dialogue detection accuracy.
    
    NOTE: This uses VLM (same as agent), not memory flags!
    Memory flags are unreliable in Pokemon Emerald.
    """
    
    env = EmeraldEmulator('Emerald-GBAdvance/rom.gba', headless=True)
    env.initialize()
    env.load_state('tests/save_states/dialog2.state')
    env.tick(60)
    
    state = env.get_comprehensive_state()
    screenshot = env.get_screenshot()
    visual_data = perception_step(state, screenshot, vlm)
    
    print("\n=== VLM Visual Detection ===")
    
    on_screen_text = visual_data.get('on_screen_text', {})
    dialogue_text = on_screen_text.get('dialogue', '')
    has_dialogue = dialogue_text and len(dialogue_text.strip()) > 3
    
    print(f"Dialogue detected: {has_dialogue}")
    if has_dialogue:
        print(f"Dialogue text: '{dialogue_text}'")
    
    # Verify VLM detected the dialogue
    assert has_dialogue, "VLM should detect dialogue in dialog2.state screenshot"
    
    print("\n✓ VLM visual detection working correctly (same as agent)")
    print("✓ Tests use VLM to validate agent behavior realistically")
    
    env.close()


def test_action_should_prioritize_dialogue(vlm):
    """
    Test that when VLM detects dialogue, agent should press A.
    
    NOTE: Tests use VLM (same as agent) for realistic behavior validation!
    """
    
    env = EmeraldEmulator('Emerald-GBAdvance/rom.gba', headless=True)
    env.initialize()
    env.load_state('tests/save_states/dialog2.state')
    env.tick(60)
    
    # Use VLM to detect dialogue (same as agent)
    state = env.get_comprehensive_state()
    screenshot = env.get_screenshot()
    visual_data = perception_step(state, screenshot, vlm)
    
    on_screen_text = visual_data.get('on_screen_text', {})
    dialogue_text = on_screen_text.get('dialogue', '')
    has_dialogue = dialogue_text and len(dialogue_text.strip()) > 3
    
    print("\n=== Action Priority Test (VLM - Agent's Method) ===")
    print(f"VLM detected dialogue: {has_dialogue}")
    if has_dialogue:
        print(f"Dialogue text: '{dialogue_text}'")
    print(f"Expected action: Press A to advance dialogue")
    
    # Verify VLM detected dialogue
    assert has_dialogue, "VLM should detect dialogue in dialog2.state"
    
    # The action module checks VLM detection and returns ["A"]
    # See agent/action.py lines 137-142 for VLM dialogue priority
    print("\n✓ VLM confirmed dialogue present - agent should press A")
    print("✓ See agent/action.py lines 137-142 for VLM-based dialogue handling")
    print("✓ Tests and agent use same VLM detection method")
    
    env.close()

